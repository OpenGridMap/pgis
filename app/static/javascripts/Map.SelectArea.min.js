/**
 * L.Map.SelectArea - Area selection tool for leaflet
 *
 * @author Alexander Milevski <info@w8r.name>
 * @see https://github.com/w8r/leaflet-area-select
 * @license MIT
 * @preserve
 */
!function(t){var e;if("function"==typeof define&&define.amd)define(["leaflet"],t);else if("undefined"!=typeof module)e=global.L||require("leaflet"),module.exports=t(e);else{if("undefined"==typeof window.L)throw new Error("Leaflet must be loaded first");t(window.L)}}(function(t){t.Util.trueFn=t.Util.trueFn||function(){return!0},t.Map.SelectArea=t.Map.BoxZoom.extend({statics:{AREA_SELECTED:"areaselected",AREA_SELECT_START:"areaselectstart",AREA_SELECTION_TOGGLED:"areaselecttoggled"},options:{shiftKey:!1,ctrlKey:!0,validate:t.Util.trueFn,autoDisable:!1,cursor:"crosshair"},initialize:function(e,o){t.Util.setOptions(this,o||{}),t.Map.BoxZoom.prototype.initialize.call(this,e),this._validate=null,this._moved=!1,this._autoDisable=!this.options.ctrlKey&&this.options.autoDisable,this._lastLayerPoint=null,this._beforeCursor=null,this.setValidate(this.options.validate),this.setAutoDisable(this.options.autoDisable)},setValidate:function(e){var o=this;return"function"!=typeof e&&(e=t.Util.trueFn),this._validate=function(t){return e.call(o,t)},this},setAutoDisable:function(t){this._autoDisable=!!t},setControlKey:function(t){var e=this._enabled;e&&this.disable(),this.options.ctrlKey=!!t,t&&(this.options.shiftKey=!1),e&&this.enable()},setShiftKey:function(t){var e=this._enabled;e&&this.disable(),this.options.shiftKey=!!t,t&&(this.options.ctrlKey=!1),e&&this.enable()},enable:function(e,o){this.options.shiftKey?this._map.boxZoom&&this._map.boxZoom.disable():this.options.ctrlKey||this._map.dragging.disable(),t.Map.BoxZoom.prototype.enable.call(this),this.options.ctrlKey||this._setCursor(),e&&this.setValidate(e),this.setAutoDisable(o),this._map.fire(t.Map.SelectArea.AREA_SELECTION_TOGGLED)},disable:function(){t.Map.BoxZoom.prototype.disable.call(this),this.options.ctrlKey||this._restoreCursor(),this.options.shiftKey?this._map.boxZoom&&this._map.boxZoom.enable():this._map.dragging.enable(),this._map.fire(t.Map.SelectArea.AREA_SELECTION_TOGGLED)},addHooks:function(){t.Map.BoxZoom.prototype.addHooks.call(this),t.DomEvent.on(document,"keyup",this._onKeyUp,this).on(document,"keydown",this._onKeyPress,this).on(document,"contextmenu",this._onMouseDown,this).on(window,"blur",this._onBlur,this),this._map.on("dragstart",this._onMouseDown,this)},removeHooks:function(){t.Map.BoxZoom.prototype.removeHooks.call(this),t.DomEvent.off(document,"keyup",this._onKeyUp,this).off(document,"keydown",this._onKeyPress,this).off(document,"contextmenu",this._onMouseDown,this).off(window,"blur",this._onBlur,this),this._map.off("dragstart",this._onMouseDown,this)},_onMouseDown:function(e){if(this._moved=!1,this._lastLayerPoint=null,this.options.shiftKey&&!e.shiftKey||this.options.ctrlKey&&!e.ctrlKey||1!==e.which&&1!==e.button)return!1;t.DomEvent.stop(e);var o=this._map.mouseEventToLayerPoint(e);return this._validate(o)?(t.DomUtil.disableTextSelection(),t.DomUtil.disableImageDrag(),this._startLayerPoint=o,void t.DomEvent.on(document,"mousemove",this._onMouseMove,this).on(document,"mouseup",this._onMouseUp,this).on(document,"keydown",this._onKeyDown,this)):!1},_onMouseMove:function(e){this._moved||(this._box=t.DomUtil.create("div","leaflet-zoom-box",this._pane),t.DomUtil.setPosition(this._box,this._startLayerPoint),this._map.fire(t.Map.SelectArea.AREA_SELECT_START));var o=this._startLayerPoint,i=this._box,s=this._map.mouseEventToLayerPoint(e),n=s.subtract(o);if(this._validate(s)){this._lastLayerPoint=s;var a=new t.Point(Math.min(s.x,o.x),Math.min(s.y,o.y));t.DomUtil.setPosition(i,a),this._moved=!0,i.style.width=Math.max(0,Math.abs(n.x)-4)+"px",i.style.height=Math.max(0,Math.abs(n.y)-4)+"px"}},_onKeyUp:function(t){27===t.keyCode?this._moved&&this._box&&this._finish():this.options.ctrlKey&&(this._restoreCursor(),this._map.dragging.enable())},_onKeyPress:function(t){this.options.ctrlKey&&(t.ctrlKey||"dragstart"===t.type)&&null===this._beforeCursor&&(this._setCursor(),this._map.dragging._draggable._onUp(),this._map.dragging.disable())},_onBlur:function(t){this._restoreCursor(),this._map.dragging.enable()},_setCursor:function(){this._beforeCursor=this._container.style.cursor,this._container.style.cursor=this.options.cursor},_restoreCursor:function(){this._container.style.cursor=this._beforeCursor,this._beforeCursor=null},_onMouseUp:function(e){this._finish();var o=this._map,i=this._lastLayerPoint;if(i&&!this._startLayerPoint.equals(i)){t.DomEvent.stop(e);var s=new t.LatLngBounds(o.layerPointToLatLng(this._startLayerPoint),o.layerPointToLatLng(i));this._autoDisable?this.disable():this._restoreCursor(),this._moved=!1,t.Util.requestAnimFrame(function(){o.fire(t.Map.SelectArea.AREA_SELECTED,{bounds:s})})}}}),t.Map.mergeOptions({selectArea:!1}),t.Map.addInitHook("addHandler","selectArea",t.Map.SelectArea)});

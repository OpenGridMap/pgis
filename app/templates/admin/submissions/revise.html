{% extends 'admin/base.html' %}
{% block content %}

<div class="container center-block clearfix">
	<h3>Revise Submission</h3>

	<div class="row">
	  <div class="col-md-7">
	    <div id="map" style="width:648px; height:648px;"></div>
	  </div>
	   <div class="col-md-5">
	     <p>
	       Received: {{ submission.points | length }} / {{ submission.number_of_points }} expected points
	     </p>
       <p>
        <button class="btn btn-success" data-toggle="modal" data-target="#reviseModalForm">Revise point</button>
        <!-- <button class="btn btn-default" data-toggle="modal" data-target="#mergeModalForm">Merge Into Existing Point</button> -->
           <!-- pictures -->
       <div id="pictures">
           {% for point in submission.points %}
               <div style="margin-bottom: 4px;">
                   <a href="/static/uploads/submissions/{{ point.submission_id }}/{{ point.id }}.png"><img src="{{ ("submissions/" ~ point.submission_id ~ "/" ~ point.id ~ ".png")|resize('350x350', placeholder=true) }}" target="_blank" style="max-width: 350px; max-height: 350px;"></a>
                   <br />Point ID: {{ point.id }}
                   <br />Latitude: {{ point.latitude }}
                   <br />Longtitude: {{ point.longitude }}
               </div>
           {% endfor %}
       </div>

        <!-- Modal -->
        <div class="modal fade" id="reviseModalForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Fill the resulting point data</h4>
              </div>
              <form action="/admin/submissions/accept_submission/{{ submission.id }}" method="POST">
                      <div class="modal-body">
                        {{ form.hidden_tag() }}
                        <div class="form-group">
                          <label class="control-label" for="point_field_latitude">Latitude</label>
                          {{ form.latitude(class_="form-control", value=mid_point[0], placeholder="48.1333") }}
                        </div>
                        <div class="form-group">
                          <label class="control-label" for="point_field_longitude">Longitude</label>
                          {{ form.longitude(class_="form-control", value=mid_point[1], placeholder="11.5667") }}
                        </div>
                        <div class="form-group">
                          <label class="control-label" for="point_field_properties">Properties</label>
                          {{ form.properties(class_="form-control json-propeties-textarea", rows="10" ) }}
                          <button type="button" class="btn btn-default btn-xs textarea-json-beautify-button">Beautify</button>
                        </div>
                        <p>
                            Possible power_element_tags:<br /> "Transfomer", "Substation", "Generator", "PV or Wind Farm", "Other"
                        </p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-danger pull-left" data-toggle="modal"
                                data-target="#deleteModalForm">
                            <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                        </button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <a class="btn btn-primary" href="/admin/submissions/reject/{{submission.id}}">
                           Reject</a>
                        <button type="submit" name="btn" value="accept_go_overview" class="btn btn-primary">
                            Accept
                        </button>
                        <button type="submit" name="btn" value="accept_go_next" class="btn btn-primary">
                            Accept and go to next
                        </button>
                      </div>
              </form>
            </div>
          </div>
        </div>

       <div class="modal fade" id="deleteModalForm" tabindex="-1" role="dialog" aria-labelledby="deleteModal">
           <div class="modal-dialog" role="document">
               <div class="modal-content">
                   <div class="modal-header">
                       <h4 class="modal-title" id="deleteModal">Delete submission {{ submission.submission_id }}</h4>
                   </div>
                   <div class="modal-body">
                       <p>Are you shure to delete submission {{ submission.submission_id }}?<br />
                           This will be final and can't be undone</p>
                   </div>
                   <div class="modal-footer">
                       <a class="btn btn-danger pull-left" href="/admin/submissions/delete/{{submission.id}}">
                           Delete permanently</a>
                       <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                   </div>
               </div>
           </div>
       </div>
       </p>
	   </div>
	</div>
</div>

{% endblock %}
{% block scripts %}
{{super()}}
{% raw %}
<script id="new-marker-popup-template" type="text/x-handlebars-template">
        <div class="panel panel-default">
          <div class="panel-heading">Point {{ point.id }}</div>
          <div class="panel-body">
                <p><strong>LatLng:</strong> {{ point.latlng }}</p>
                <p><strong>Photo:</strong> <img src="/static/uploads/submissions/{{submission.id}}/{{point.id}}.png" width="50" height="50"/></p>
                <p><strong>Tags:</strong> {{ json point.tags }}</p>
          </div>
        </div>
</script>

<script id="marker-popup-template" type="text/x-handlebars-template">
        <div class="panel panel-default">
          <div class="panel-heading">Point {{ id }}</div>
          <div class="panel-body">
                <p><strong>LatLng:</strong> {{ latlng }}</p>
                <p><strong>Photo:</strong> <a href="/static/uploads/submissions/{{submission.id}}/{{point.id}}.png"
                                             target="_blank">Open photo in new tab</a></p>
                <p><strong>Tags:</strong> {{ json tags }}</p>
          </div>
        </div>
</script>
{% endraw %}
<script>
  $(document).ready(function(){
    Handlebars.registerHelper('json', function(context) {
      return JSON.stringify(context, null, 4);
    });

    var source = $("#new-marker-popup-template").html();
    var newMarkerPopupTemplate = Handlebars.compile(source);
    source = $("#marker-popup-template").html();
    var markerPopupTemplate = Handlebars.compile(source);


    var redIcon = new L.Icon.Default({iconUrl: '/static/images/marker-icon-red-2x.png'});
    var newMarkers = [];
    {% for point in submission.points %}
    var pointData = {{ point.serialize() | tojson }}
    var popupData = { submission: {{ submission.serialize() | tojson }}, point : pointData }
    var popup = newMarkerPopupTemplate(popupData);
    var newMarker = new L.Marker([{{ point.latitude }}, {{ point.longitude }}], {icon: redIcon});
    newMarker.bindPopup(popup);
    newMarkers.push(newMarker);
    {% endfor %}

    var map = L.map('map').setView([48.11, 11.0], 5);
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18
        }).addTo(map);

    // add already accepted markers
    var markers = new L.MarkerClusterGroup();
	map.addLayer(markers);
	var clusterGroup = new L.LayerGroup();
	map.addLayer(clusterGroup);
    loadMapFragment();

    // Initialise the FeatureGroup to store editable layers
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    for(var i = 0; i < newMarkers.length; i++){
      drawnItems.addLayer(newMarkers[i]);
    }
    map.fitBounds(drawnItems.getBounds());

    // update markers on map movement
    var loadFragmentDebounced = _.debounce(loadMapFragment, 1000);
    map.on('moveend', function(){
      loadFragmentDebounced();
    });


    function loadMapFragment(){
      if(map.getZoom() > 11) {
        $.ajax({
          url : "/points",
          data: {
            "bounds" : map.getBounds().toBBoxString()
          },
          success : function(data){
            markers.clearLayers();
            clusterGroup.clearLayers();
            for(var i = 0; i < data.length; i++){
              var marker = new L.Marker(data[i]['latlng']);
              var popup = markerPopupTemplate(data[i]);
              marker.bindPopup(popup);
              markers.addLayer(marker);
            }
          }
        });
      } else {
        $.ajax({
          url : "/points/clustered",
          data : {
            "zoom" : map.getZoom(),
            "bounds" : map.getBounds().toBBoxString()
          },
          success : function(data){
            markers.clearLayers();
            clusterGroup.clearLayers();
            for(var i = 0; i < data.length; i++){
              var marker = new L.Marker(data[i]['latlng'], {
                icon: iconCreateFunction(data[i])
              });
              clusterGroup.addLayer(marker);
              marker.on('click', function(e){
                map.setView(e.target.getLatLng(), map.getZoom() + 1);
              });
            }
          }
        });
    }
  }

  var iconCreateFunction = function (cluster) {
    var count = cluster.count;
    // cluster icon
    var c = 'marker-cluster-';
    if (count < 10) {
      c += 'small';
    } else if (count < 100) {
      c += 'medium';
    } else {
      c += 'large';
    }

    return new L.DivIcon({
      html: '<div><span>' + count + '</span></div>',
      className: 'marker-cluster ' + c,
      iconSize: new L.Point(40, 40)
    });
  };

});

</script>
{% endblock %}

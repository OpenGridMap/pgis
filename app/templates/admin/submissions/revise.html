{% extends 'admin/base.html' %}
{% block content %}

<div class="container center-block clearfix">
	<h3>Revise Submission</h3>

	<div class="row">
	  <div class="col-md-7">
	    <div id="map" style="width:648px; height:648px;"></div>
	  </div>
	   <div class="col-md-5">
	     <p>
	       Received: {{ submission.points | length }} / {{ submission.number_of_points }} expected points
	     </p>
       <p>
        <button class="btn btn-success" data-toggle="modal" data-target="#mergeModalForm">Merge</button>
        <!-- Modal -->
        <div class="modal fade" id="mergeModalForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Fill the resulting point data</h4>
              </div>
              <div class="modal-body">
                ...
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Merge</button>
              </div>
            </div>
          </div>
        </div>
       </p>
	   </div>
	</div>
</div>

{% endblock %}
{% block scripts %}
{{super()}}
{% raw %}
<script id="marker-popup-template" type="text/x-handlebars-template">
        <div class="panel panel-default">
          <div class="panel-heading">Point {{ point.id }}</div>
          <div class="panel-body">
                <p><strong>LatLng:</strong> {{ point.latlng }}</p>
                <p><strong>Photo:</strong><img src="/static/uploads/submissions/{{submission.id}}/{{point.id}}.png" width="50" height="50"/></p>
                <p><strong>Tags:</strong> {{ json point.tags }}</p>
          </div>
        </div>
</script>
{% endraw %}
<script>
  $(document).ready(function(){
    Handlebars.registerHelper('json', function(context) {
      return JSON.stringify(context, null, 4);
    });

    var source   = $("#marker-popup-template").html();
    var markerPopupTemplate = Handlebars.compile(source);

    var markers = [];
    {% for point in submission.points %}
    var pointData = {{ point.serialize() | tojson }}
    var popupData = { submission: {{ submission.serialize() | tojson }}, point : pointData }
    var popup = markerPopupTemplate(popupData);
    var marker = new L.Marker([{{ point.latitude }}, {{ point.longitude }}]);
    marker.bindPopup(popup);
    markers.push(marker);
    {% endfor %}

    var map = L.map('map').setView([48.11, 11.0], 5);
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18
        }).addTo(map);

    // Initialise the FeatureGroup to store editable layers
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    for(var i = 0; i < markers.length; i++){
      drawnItems.addLayer(markers[i]);
    }
    map.fitBounds(drawnItems.getBounds());
  });
</script>
{% endblock %}
